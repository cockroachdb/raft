# This test explores what happens when a fully caught-up follower transitions
# into StateProbe (for example due to a call to ReportUnreachable). Ideally, it
# would transition back to StateReplicate via a heartbeat response, but it
# currently doesn't.

# Turn off output during the setup of the test.
log-level none
----
ok

add-nodes 3 voters=(1,2,3) index=10
----
ok

campaign 1
----
ok

stabilize
----
ok (quiet)

log-level debug
----
ok

status 1
----
1: StateReplicate match=11 next=12
2: StateReplicate match=11 next=12
3: StateReplicate match=11 next=12

# On the first replica, report the second one as not reachable.
report-unreachable 1 2
----
DEBUG 1 failed to send message to 2 because it is unreachable [StateProbe match=11 next=12]

status 1
----
1: StateReplicate match=11 next=12
2: StateProbe match=11 next=12
3: StateReplicate match=11 next=12

tick-heartbeat 1
----
ok

stabilize
----
> 1 handling Ready
  Ready MustSync=false:
  Messages:
  1->2 MsgHeartbeat Term:1 Log:0/0 Commit:11
  1->3 MsgHeartbeat Term:1 Log:0/0 Commit:11
> 2 receiving messages
  1->2 MsgHeartbeat Term:1 Log:0/0 Commit:11
> 3 receiving messages
  1->3 MsgHeartbeat Term:1 Log:0/0 Commit:11
> 2 handling Ready
  Ready MustSync=false:
  Messages:
  2->1 MsgHeartbeatResp Term:1 Log:0/0
> 3 handling Ready
  Ready MustSync=false:
  Messages:
  3->1 MsgHeartbeatResp Term:1 Log:0/0
> 1 receiving messages
  2->1 MsgHeartbeatResp Term:1 Log:0/0
  3->1 MsgHeartbeatResp Term:1 Log:0/0

# Sad, replica is still tracked as probing.
status 1
----
1: StateReplicate match=11 next=12
2: StateProbe match=11 next=12
3: StateReplicate match=11 next=12

# Need to actually distribute a command to sort things out.
# This should not be necessary.
propose 1 foo
----
ok

stabilize
----
> 1 handling Ready
  Ready MustSync=true:
  Entries:
  1/12 EntryNormal "foo"
  Messages:
  1->2 MsgApp Term:1 Log:1/11 Commit:11 Entries:[1/12 EntryNormal "foo"]
  1->3 MsgApp Term:1 Log:1/11 Commit:11 Entries:[1/12 EntryNormal "foo"]
> 2 receiving messages
  1->2 MsgApp Term:1 Log:1/11 Commit:11 Entries:[1/12 EntryNormal "foo"]
> 3 receiving messages
  1->3 MsgApp Term:1 Log:1/11 Commit:11 Entries:[1/12 EntryNormal "foo"]
> 2 handling Ready
  Ready MustSync=true:
  Entries:
  1/12 EntryNormal "foo"
  Messages:
  2->1 MsgAppResp Term:1 Log:0/12
> 3 handling Ready
  Ready MustSync=true:
  Entries:
  1/12 EntryNormal "foo"
  Messages:
  3->1 MsgAppResp Term:1 Log:0/12
> 1 receiving messages
  2->1 MsgAppResp Term:1 Log:0/12
  3->1 MsgAppResp Term:1 Log:0/12
> 1 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:12
  CommittedEntries:
  1/12 EntryNormal "foo"
  Messages:
  1->2 MsgApp Term:1 Log:1/12 Commit:12
  1->3 MsgApp Term:1 Log:1/12 Commit:12
> 2 receiving messages
  1->2 MsgApp Term:1 Log:1/12 Commit:12
> 3 receiving messages
  1->3 MsgApp Term:1 Log:1/12 Commit:12
> 2 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:12
  CommittedEntries:
  1/12 EntryNormal "foo"
  Messages:
  2->1 MsgAppResp Term:1 Log:0/12
> 3 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:12
  CommittedEntries:
  1/12 EntryNormal "foo"
  Messages:
  3->1 MsgAppResp Term:1 Log:0/12
> 1 receiving messages
  2->1 MsgAppResp Term:1 Log:0/12
  3->1 MsgAppResp Term:1 Log:0/12

status 1
----
1: StateReplicate match=12 next=13
2: StateReplicate match=12 next=13
3: StateReplicate match=12 next=13
